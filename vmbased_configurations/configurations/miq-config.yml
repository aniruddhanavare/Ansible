#- hosts: localhost
#  vars_files:
#      - group_vars/all/vars.yml
#  tasks:
#    - include_tasks: reset-default-passwor.yml
#      loop: "{{ query('inventory_hostnames', 'master_primary_db') }}" 
    
#    - include_tasks: reset-default-passwor.yml
#      loop: "{{ query('inventory_hostnames', 'master_primary_appliance') }}" 


## All hosts
- hosts: master_primary_db
  become: yes
  vars:
    ansible_ssh_pass: "{{ cfme_new_root_pw }}"
    ansible_ssh_user: root

  tasks: 
  - name: Synchronize time
    become: yes
    service:
      name: 'chronyd'
      enabled: 'yes'
      state: 'started'
    tags: 'chrony-service'

  - name: Restore default database configuration file
    command: " {{ item }} "
    with_items: 
      - systemctl stop evmserverd
      - cd {{ cfme_vmdb_default_folder }}
      - \cp {{ cfme_vmdb_default_folder }}/config/database.pg.yml {{ cfme_vmdb_default_folder }}/config/database.yml
      - systemctl restart $APPLIANCE_PG_SERVICE
      - su - postgres -c "dropdb  -U root  vmdb_production --if-exists"
  
  - name: Reset configured database
    ansible.builtin.shell:
     chdir: "{{ cfme_vmdb_default_folder }}"
     cmd: DISABLE_DATABASE_ENVIRONMENT_CHECK=1 bin/rake evm:db:region -- --region={{ miq_region }}


