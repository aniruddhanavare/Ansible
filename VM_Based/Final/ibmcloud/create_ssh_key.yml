---
- name: Generate /etc/ssh/ RSA host key
  command : ssh-keygen -t rsa -f /tmp/ssh_host_rsa_key -C "" -q -N ""
  args:
    creates: /tmp/ssh_host_rsa_key
  register: ssh_rsa_output   

- name: Changing perm of "/tmp/ssh_host_rsa_key"
  file: dest=/tmp/ssh_host_rsa_key mode=400

- command : cat /tmp/ssh_host_rsa_key.pub
  register: ssh_public_key

- block:
  - name: Create SSH Key
    ibm_is_ssh_key:
      name: "{{ name_prefix }}-ssh-key"
      public_key: "{{ ssh_public_key.stdout }}"
      tags: "{{ tag }}"
      resource_group: "{{ resource_group_id }}"
      region: "{{ region }}"
      ibmcloud_api_key: "{{ provider_apikey }}"
    register: ssh_key_create_output
  rescue:
  - name: Get existing SSH key 
    ibm_is_ssh_key_info:
      name: "{{ name_prefix }}-ssh-key"
      region: "{{ region }}"
      ibmcloud_api_key: "{{ provider_apikey }}"
    register: ssh_key_create_output

- name: Save SSH Key as fact
  set_fact:
    cacheable: True
    ssh_key: "{{ ssh_key_create_output.resource }}"


